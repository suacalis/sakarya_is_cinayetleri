<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakarya ƒ∞≈ü Kazalarƒ± Haritasƒ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        #header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        #fileUpload {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #5568d3;
        }

        #fileName {
            font-size: 13px;
            color: #666;
            font-style: italic;
            flex: 1;
            min-width: 150px;
        }

        #downloadTemplate {
            padding: 8px 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        #downloadTemplate:hover {
            background: #229954;
        }

        #controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        input[type="text"], input[type="date"], select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="text"] {
            width: 250px;
        }

        button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: auto;
        }

        button:hover {
            background: #5568d3;
        }

        button.reset {
            background: #e74c3c;
        }

        button.reset:hover {
            background: #c0392b;
        }

        #map {
            flex: 1;
            width: 100%;
            min-height: 500px;
            position: relative;
            background-color: #e8e8e8;
        }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #stats-section {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            border-left: 2px solid #e0e0e0;
            overflow-y: auto;
        }

        #stats-header {
            background: white;
            padding: 12px 15px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        #infographic-side {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .info-cards-side {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-card-small {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .info-card-small:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        }

        .card-icon-small {
            font-size: 28px;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
            min-width: 0;
        }

        .card-title-small {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .card-value-small {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .charts-side {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-box-side {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .chart-box-side h3 {
            font-size: 14px;
            color: #333;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        #stats {
            background: white;
            padding: 10px 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .toggle-btn {
            padding: 6px 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 0;
        }

        .toggle-btn:hover {
            background: #229954;
        }

        #infographic {
            background: #f8f9fa;
            padding: 20px;
            display: none;
            overflow-y: auto;
            max-height: 600px;
        }

        #infographic.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .chart-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-box h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .chart-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .chart-label {
            flex: 0 0 120px;
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .chart-bar-container {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 10px;
        }

        .chart-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            transition: width 0.5s ease;
        }

        .chart-value {
            flex: 0 0 40px;
            text-align: right;
            font-size: 13px;
            font-weight: bold;
            color: #667eea;
        }

        .leaflet-popup-content {
            margin: 15px;
            width: 300px !important;
        }

        .popup-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .popup-info {
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.6;
        }

        .popup-label {
            font-weight: 600;
            color: #555;
        }

        .popup-link {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.3s;
        }

        .popup-link:hover {
            background: #5568d3;
        }

        .marker-cluster {
            background: rgba(255, 165, 0, 0.6);
        }

        .marker-cluster div {
            background: rgba(255, 140, 0, 0.8);
            color: white;
            font-weight: bold;
        }

        .custom-marker {
            background: #e74c3c;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .boundary-tooltip {
            background: rgba(214, 48, 49, 0.9);
            border: 2px solid #a71d1d;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 13px;
            padding: 5px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .boundary-tooltip::before {
            border-top-color: rgba(214, 48, 49, 0.9);
        }

        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }

        .map-legend h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-line {
            width: 30px;
            height: 3px;
            background: #d63031;
            margin-right: 8px;
            border-radius: 2px;
        }

        .legend-line.dashed {
            background: repeating-linear-gradient(
                to right,
                #d63031 0,
                #d63031 8px,
                transparent 8px,
                transparent 12px
            );
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #27ae60;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        #notification.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 10px 20px;
            font-size: 13px;
            color: #856404;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 1024px) {
            #main-container {
                flex-direction: column;
            }

            #stats-section {
                width: 100%;
                max-height: 400px;
                border-left: none;
                border-top: 2px solid #e0e0e0;
            }
        }

        @media (max-width: 768px) {
            #controls, #fileUpload {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="text"] {
                width: 100%;
            }

            .control-group {
                width: 100%;
            }

            #stats-header {
                flex-direction: row;
                justify-content: space-around;
            }

            .info-cards-side {
                gap: 8px;
            }

            .chart-label {
                flex: 0 0 70px;
                font-size: 10px;
            }

            .map-legend {
                bottom: 10px;
                right: 10px;
                left: 10px;
                font-size: 11px;
            }

            .map-legend h4 {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üèóÔ∏è Sakarya ƒ∞≈ü Kazalarƒ± √ñl√ºm Haritasƒ±</h1>
    </div>

    <div id="fileUpload">
        <div class="file-input-wrapper">
            <label for="excelFile" class="file-input-label">üìÅ Dosya Y√ºkle</label>
            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
        </div>
        <span id="fileName">Dosya se√ßilmedi</span>
        <button id="downloadTemplate" onclick="downloadTemplate()">üì• ≈ûablon ƒ∞ndir</button>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Arama</label>
            <input type="text" id="searchBox" placeholder="ƒ∞sim, Yer, Neden...">
        </div>
        
        <div class="control-group">
            <label>Ba≈ülangƒ±√ß</label>
            <input type="date" id="startDate">
        </div>
        
        <div class="control-group">
            <label>Biti≈ü</label>
            <input type="date" id="endDate">
        </div>
        
        <div class="control-group">
            <label>ƒ∞l√ße</label>
            <select id="cityFilter">
                <option value="">T√ºm ƒ∞l√ßeler</option>
            </select>
        </div>
        
        <button onclick="applyFilters()">Filtrele</button>
        <button class="reset" onclick="resetFilters()">Sƒ±fƒ±rla</button>
    </div>

    <div id="main-container">
        <div id="map-section">
            <div id="map">
                <div class="map-legend">
                    <h4>üó∫Ô∏è Harita G√∂stergeleri</h4>
                    <div class="legend-item">
                        <div class="legend-line dashed"></div>
                        <span>Sakarya Sƒ±nƒ±rƒ±</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker"></div>
                        <span>ƒ∞≈ü Kazasƒ±</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="stats-section">
            <div id="stats-header">
                <div class="stat-item">
                    <span class="stat-label">Toplam:</span>
                    <span class="stat-value" id="totalRecords">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">G√∂sterilen:</span>
                    <span class="stat-value" id="displayedRecords">0</span>
                </div>
            </div>
            
            <div id="infographic-side">
                <div class="info-cards-side">
                    <div class="info-card-small">
                        <div class="card-icon-small">üìä</div>
                        <div class="card-content">
                            <div class="card-title-small">En √áok √ñl√ºm</div>
                            <div class="card-value-small" id="topCity">-</div>
                        </div>
                    </div>
                    <div class="info-card-small">
                        <div class="card-icon-small">‚ö†Ô∏è</div>
                        <div class="card-content">
                            <div class="card-title-small">En Yaygƒ±n Neden</div>
                            <div class="card-value-small" id="topReason">-</div>
                        </div>
                    </div>
                    <div class="info-card-small">
                        <div class="card-icon-small">üè≠</div>
                        <div class="card-content">
                            <div class="card-title-small">En Riskli Sekt√∂r</div>
                            <div class="card-value-small" id="topSector">-</div>
                        </div>
                    </div>
                    <div class="info-card-small">
                        <div class="card-icon-small">üìÖ</div>
                        <div class="card-content">
                            <div class="card-title-small">En Yoƒüun Ay</div>
                            <div class="card-value-small" id="topMonth">-</div>
                        </div>
                    </div>
                    <div class="info-card-small">
                        <div class="card-icon-small">üèôÔ∏è</div>
                        <div class="card-content">
                            <div class="card-title-small">ƒ∞l√ße Daƒüƒ±lƒ±mƒ±</div>
                            <div class="card-value-small" id="cityCount">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="charts-side">
                    <div class="chart-box-side">
                        <h3>üìç ƒ∞l√ßelere G√∂re</h3>
                        <div id="cityChart"></div>
                    </div>
                    <div class="chart-box-side">
                        <h3>üè≠ Sekt√∂rlere G√∂re</h3>
                        <div id="sectorChart"></div>
                    </div>
                    <div class="chart-box-side">
                        <h3>‚ö†Ô∏è Nedenlere G√∂re</h3>
                        <div id="reasonChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        let dataSet = [];

        // Sakarya sƒ±nƒ±rlarƒ± (ger√ßek GeoJSON verisine g√∂re g√ºncellenmi≈ü)
        const sakaryaBounds = L.latLngBounds(
            L.latLng(40.29, 29.95),   // G√ºneybatƒ± k√∂≈üesi
            L.latLng(41.19, 31.01)    // Kuzeydoƒüu k√∂≈üesi
        );

        // Harita ba≈ülatma - Sakarya odaklƒ±
        const map = L.map('map', {
            center: [40.7569, 30.3781],  // Sakarya merkez
            zoom: 5,             // Sakarya i√ßin uygun zoom
            minZoom: 5,           // Minimum zoom seviyesi
            maxZoom: 18,          // Maximum zoom seviyesi
            maxBounds: sakaryaBounds,  // Hareket sƒ±nƒ±rlarƒ±
            maxBoundsViscosity: 0.9    // Sƒ±nƒ±rlara yapƒ±≈üma derecesi
        });

        // Gri tonlamalƒ± T√ºrkiye harita katmanƒ±
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 18
        }).addTo(map);

        // Etiketler i√ßin ayrƒ± katman (opsiyonel)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
            attribution: '',
            subdomains: 'abcd',
            maxZoom: 18,
            pane: 'shadowPane'
        }).addTo(map);

        // Sakarya ili sƒ±nƒ±rlarƒ±nƒ± ger√ßek GeoJSON verisi ile √ßiz
        const sakaryaGeoJSON = {"type":"FeatureCollection","features":[{"id":85679245,"type":"Feature","properties":{"name":"Sakarya"},"geometry":{"coordinates":[[[[30.355992,41.18236],[30.356638,41.182083],[30.357889,41.181667],[30.358305,41.178749],[30.360806,41.180363],[30.367472,41.176224],[30.369972,41.176224],[30.370861,41.175388],[30.374111,41.175388],[30.374971,41.174557],[30.376638,41.174526],[30.383278,41.171196],[30.386639,41.170418],[30.389139,41.168751],[30.390778,41.168751],[30.393278,41.167027],[30.395779,41.167084],[30.396639,41.166248],[30.401667,41.16539],[30.40661,41.162861],[30.409945,41.162888],[30.410805,41.162056],[30.414139,41.162056],[30.415001,41.161221],[30.42,41.161221],[30.423306,41.159584],[30.428333,41.158722],[30.430834,41.157055],[30.433332,41.157055],[30.434111,41.156223],[30.436611,41.156223],[30.437471,41.155388],[30.444166,41.154556],[30.444973,41.153721],[30.448305,41.153721],[30.449167,41.152889],[30.453848,41.152889],[30.45414,41.152889],[30.454945,41.152054],[30.460806,41.151196],[30.461666,41.15036],[30.468361,41.149582],[30.4725,41.147861],[30.476667,41.147888],[30.479973,41.146252],[30.484945,41.14539],[30.485806,41.144554],[30.489111,41.144554],[30.49,41.143723],[30.495806,41.143749],[30.496611,41.142887],[30.512501,41.142887],[30.513361,41.142056],[30.518362,41.142056],[30.519138,41.141277],[30.524139,41.141193],[30.525,41.140362],[30.530001,41.140362],[30.530777,41.139584],[30.535,41.139557],[30.535805,41.138695],[30.546612,41.138721],[30.547472,41.137917],[30.554138,41.13789],[30.555,41.137054],[30.564167,41.137085],[30.564945,41.13625],[30.573334,41.13625],[30.574139,41.135387],[30.578278,41.135387],[30.57914,41.134529],[30.593306,41.134556],[30.596611,41.132889],[30.6,41.132915],[30.600805,41.132084],[30.609112,41.132084],[30.613277,41.13039],[30.628334,41.130417],[30.629194,41.129581],[30.638334,41.129528],[30.639111,41.12875],[30.641611,41.12875],[30.642471,41.127918],[30.644138,41.127888],[30.64539,41.12664],[30.64539,41.125],[30.644556,41.122444],[30.642056,41.120804],[30.641251,41.115807],[30.6425,41.114582],[30.64286,41.114971],[30.643723,41.118305],[30.646223,41.120834],[30.646223,41.122501],[30.649166,41.127056],[30.6525,41.127083],[30.653278,41.126221],[30.655777,41.126221],[30.658333,41.124554],[30.662445,41.123722],[30.666611,41.12125],[30.670805,41.120419],[30.672445,41.118721],[30.674194,41.118778],[30.675833,41.117085],[30.6775,41.117054],[30.678278,41.116222],[30.680861,41.116222],[30.681639,41.11536],[30.685806,41.115391],[30.686666,41.114555],[30.691668,41.114555],[30.694139,41.112888],[30.698334,41.112057],[30.704971,41.107887],[30.708279,41.106251],[30.710777,41.106224],[30.714945,41.103748],[30.718306,41.10289],[30.720861,41.101223],[30.723362,41.101223],[30.724138,41.100388],[30.725805,41.100418],[30.726667,41.099556],[30.73,41.099529],[30.730778,41.098721],[30.735001,41.098694],[30.741638,41.09539],[30.744139,41.092888],[30.751694,41.088722],[30.754944,41.088749],[30.755806,41.087891],[30.770834,41.087917],[30.771694,41.087055],[30.776695,41.087055],[30.777472,41.086193],[30.779972,41.08625],[30.780834,41.085415],[30.789139,41.085388],[30.790001,41.084557],[30.799139,41.084557],[30.799999,41.083721],[30.809139,41.083721],[30.809999,41.08289],[30.812179,41.08289],[30.828306,41.08289],[30.829166,41.082054],[30.833334,41.082054],[30.83411,41.081223],[30.84,41.081223],[30.84086,41.08036],[30.8475,41.080387],[30.848278,41.079613],[30.854944,41.079556],[30.855806,41.078724],[30.879168,41.078751],[30.879944,41.077888],[30.888334,41.077888],[30.889111,41.077084],[30.906639,41.077057],[30.907499,41.076221],[30.921638,41.076195],[30.922501,41.075359],[30.931639,41.075417],[30.932501,41.074554],[30.950806,41.074612],[30.951639,41.07375],[30.963333,41.074528],[30.964111,41.073696],[30.964645,41.073697],[30.963931,41.066999],[30.964388,41.061738],[30.96748,41.059873],[30.971478,41.058436],[30.975864,41.055385],[30.979287,41.051232],[30.981082,41.048094],[30.983182,41.04577],[30.987162,41.044157],[30.992878,41.044906],[30.999148,41.046483],[31.003849,41.044655],[31.005256,41.038806],[31.002477,41.032904],[30.996241,41.030023],[30.990602,41.028411],[30.988144,41.025248],[30.985553,41.02],[30.979027,41.01358],[30.971155,41.009013],[30.966524,41.008042],[30.963181,41.006685],[30.959051,41.000745],[30.957664,40.991697],[30.958393,40.983405],[30.956688,40.978514],[30.951952,40.976442],[30.946544,40.974065],[30.943294,40.971529],[30.942549,40.970643],[30.935568,40.959011],[30.932525,40.951683],[30.926721,40.949223],[30.919479,40.948801],[30.913435,40.94485],[30.909724,40.93735],[30.904765,40.93079],[30.896347,40.92633],[30.889163,40.922758],[30.88427,40.919516],[30.877135,40.915198],[30.86928,40.912272],[30.862952,40.913771],[30.856736,40.916102],[30.852484,40.916406],[30.85139,40.91617],[30.834252,40.909792],[30.832524,40.908557],[30.825414,40.902223],[30.818071,40.898417],[30.813584,40.891725],[30.812484,40.883793],[30.811133,40.878379],[30.809848,40.873864],[30.811969,40.868265],[30.817591,40.863242],[30.824874,40.862329],[30.834001,40.866812],[30.844646,40.87127],[30.853358,40.871623],[30.860257,40.870401],[30.869294,40.869365],[30.877432,40.866027],[30.879132,40.859243],[30.875887,40.852844],[30.872214,40.849138],[30.870403,40.846997],[30.870412,40.844565],[30.872059,40.839746],[30.875635,40.834616],[30.880399,40.832789],[30.884664,40.833211],[30.887853,40.832728],[30.890229,40.828818],[30.889683,40.82192],[30.884579,40.816265],[30.878564,40.813806],[30.875061,40.81247],[30.871181,40.81108],[30.863168,40.808873],[30.85456,40.80434],[30.848916,40.798957],[30.842931,40.794002],[30.836673,40.788338],[30.833737,40.7839],[30.833312,40.782575],[30.830191,40.772661],[30.830714,40.768545],[30.836025,40.763452],[30.844353,40.758606],[30.852228,40.755914],[30.859918,40.754546],[30.866056,40.753066],[30.869751,40.749675],[30.8742,40.743672],[30.879357,40.736917],[30.883482,40.732465],[30.887818,40.730272],[30.893569,40.727003],[30.899962,40.722848],[30.905095,40.720359],[30.909376,40.718977],[30.915581,40.718718],[30.922931,40.721391],[30.929491,40.723545],[30.936201,40.720103],[30.940444,40.712702],[30.93929,40.704756],[30.936678,40.698182],[30.936946,40.693308],[30.939996,40.688117],[30.941557,40.682155],[30.938545,40.674682],[30.93482,40.665741],[30.933763,40.659743],[30.93384,40.658211],[30.916054,40.659941],[30.909078,40.6641],[30.902707,40.662514],[30.898842,40.656915],[30.897522,40.652343],[30.897337,40.650963],[30.894801,40.636399],[30.894211,40.62921],[30.892222,40.624036],[30.890434,40.621461],[30.889731,40.620079],[30.8884,40.618116],[30.88525,40.615642],[30.880922,40.612494],[30.87809,40.606864],[30.878028,40.598925],[30.877347,40.591533],[30.874749,40.586971],[30.872826,40.58378],[30.871831,40.578305],[30.870529,40.571069],[30.868383,40.565265],[30.866461,40.561419],[30.865997,40.557929],[30.866069,40.554248],[30.867393,40.549917],[30.871703,40.543687],[30.876522,40.53744],[30.87843,40.532718],[30.876764,40.528124],[30.872824,40.523119],[30.869392,40.517603],[30.867922,40.512755],[30.86759,40.51043],[30.867549,40.51],[30.846152,40.517066],[30.837877,40.516231],[30.832405,40.513538],[30.825988,40.510781],[30.816889,40.508054],[30.805955,40.505542],[30.7943,40.501893],[30.785641,40.497951],[30.781246,40.497092],[30.776841,40.498914],[30.77083,40.501012],[30.764835,40.50256],[30.760006,40.50302],[30.756472,40.500677],[30.752793,40.49554],[30.748472,40.492095],[30.744796,40.493429],[30.742589,40.496797],[30.741139,40.499118],[30.738286,40.499898],[30.73311,40.498944],[30.728075,40.497251],[30.723505,40.497148],[30.717035,40.499588],[30.70873,40.503849],[30.698754,40.50906],[30.68952,40.51435],[30.684531,40.518195],[30.681003,40.518663],[30.675525,40.515653],[30.668,40.511977],[30.658607,40.508866],[30.650353,40.505414],[30.64649,40.502323],[30.643514,40.498845],[30.636467,40.494688],[30.62771,40.493582],[30.621063,40.494167],[30.615718,40.490926],[30.612027,40.485506],[30.610119,40.481531],[30.605894,40.478757],[30.59854,40.477843],[30.593015,40.478679],[30.591476,40.479228],[30.587703,40.465985],[30.587893,40.461414],[30.585905,40.456134],[30.581058,40.451339],[30.575889,40.445036],[30.572048,40.437893],[30.568946,40.431137],[30.568181,40.424651],[30.569922,40.418214],[30.571271,40.410469],[30.572198,40.403859],[30.575041,40.400744],[30.5797,40.398524],[30.583168,40.395847],[30.584093,40.39308],[30.584001,40.389222],[30.582545,40.382846],[30.57745,40.375924],[30.570044,40.370147],[30.565213,40.362488],[30.566786,40.353453],[30.574017,40.346324],[30.581476,40.342543],[30.587705,40.343094],[30.596276,40.343942],[30.605056,40.340416],[30.609348,40.335186],[30.609161,40.331469],[30.606402,40.328571],[30.602018,40.326837],[30.595981,40.327725],[30.590026,40.331373],[30.584054,40.333632],[30.575614,40.329199],[30.568579,40.322197],[30.567007,40.317577],[30.569405,40.312178],[30.574658,40.305267],[30.580299,40.299088],[30.583073,40.294828],[30.583554,40.293233],[30.583548,40.293092],[30.558014,40.290472],[30.54144,40.295427],[30.530458,40.297991],[30.524765,40.302126],[30.517657,40.307052],[30.50841,40.309516],[30.501883,40.309723],[30.497769,40.310065],[30.49456,40.310888],[30.49146,40.311769],[30.486379,40.314002],[30.480554,40.319317],[30.479852,40.325928],[30.484716,40.331599],[30.488607,40.337281],[30.488892,40.343177],[30.488165,40.349068],[30.486507,40.355167],[30.482096,40.359979],[30.477224,40.362934],[30.473677,40.36626],[30.46887,40.371388],[30.461005,40.375687],[30.450935,40.377311],[30.442996,40.378267],[30.438953,40.380825],[30.434379,40.385301],[30.427457,40.387655],[30.419226,40.384916],[30.41164,40.381233],[30.407672,40.380085],[30.406872,40.380113],[30.384366,40.390503],[30.375324,40.393486],[30.365699,40.389133],[30.355375,40.383976],[30.347508,40.382933],[30.339406,40.384075],[30.325916,40.384965],[30.312191,40.386921],[30.304586,40.387667],[30.298787,40.382754],[30.290796,40.375707],[30.282605,40.371695],[30.274816,40.369456],[30.267541,40.366565],[30.261475,40.363816],[30.254571,40.360927],[30.24647,40.356038],[30.239384,40.352331],[30.232514,40.352949],[30.225269,40.354229],[30.220161,40.353472],[30.218014,40.352246],[30.217334,40.351607],[30.217169,40.351429],[30.204528,40.353478],[30.200137,40.351962],[30.195667,40.350821],[30.191819,40.350989],[30.186815,40.350989],[30.180799,40.350501],[30.17591,40.35085],[30.171946,40.353589],[30.165804,40.359388],[30.156511,40.363799],[30.147478,40.363074],[30.141156,40.361715],[30.134964,40.364308],[30.126984,40.369058],[30.120378,40.37331],[30.116114,40.377582],[30.111269,40.382982],[30.104786,40.389638],[30.096725,40.397098],[30.090266,40.403081],[30.088845,40.408612],[30.090038,40.417682],[30.091298,40.42808],[30.09124,40.436901],[30.088417,40.444788],[30.085027,40.450954],[30.083623,40.454263],[30.083482,40.455163],[30.065316,40.452143],[30.058485,40.447134],[30.05343,40.441663],[30.05121,40.435894],[30.048091,40.428704],[30.040618,40.423881],[30.032234,40.426058],[30.027685,40.430702],[30.024025,40.432347],[30.017362,40.432861],[30.010723,40.435904],[30.007442,40.442078],[30.00548,40.448344],[30.003419,40.453765],[30.002845,40.461139],[30.001878,40.468962],[29.997373,40.475424],[29.991438,40.483373],[29.986898,40.491941],[29.984047,40.498613],[29.98151,40.505505],[29.977642,40.512586],[29.97429,40.516501],[29.973276,40.517325],[29.96988,40.527521],[29.965994,40.528567],[29.962121,40.531433],[29.959227,40.54006],[29.957441,40.548655],[29.956875,40.551507],[29.969653,40.549535],[29.980106,40.549108],[29.989019,40.550721],[29.99289,40.553929],[29.995072,40.560283],[29.998049,40.56875],[30.001369,40.57496],[30.005468,40.578019],[30.009594,40.579499],[30.01363,40.580301],[30.020724,40.58076],[30.030112,40.580434],[30.037235,40.580257],[30.041892,40.582312],[30.046348,40.586295],[30.049721,40.589424],[30.050766,40.590357],[30.061412,40.588596],[30.066534,40.587534],[30.072323,40.587995],[30.07754,40.591762],[30.08214,40.597404],[30.085587,40.601525],[30.089297,40.601528],[30.095162,40.597211],[30.101871,40.593294],[30.107853,40.593885],[30.112107,40.597595],[30.113503,40.603352],[30.114722,40.610261],[30.119315,40.615749],[30.124429,40.618587],[30.12624,40.619331],[30.13266,40.632081],[30.136238,40.634288],[30.140704,40.637442],[30.146144,40.644938],[30.150946,40.653138],[30.1542,40.659257],[30.157457,40.665909],[30.160876,40.672833],[30.163212,40.679901],[30.165066,40.689324],[30.165046,40.697743],[30.160965,40.702174],[30.155318,40.705914],[30.152488,40.711664],[30.154165,40.718732],[30.159032,40.724097],[30.164768,40.725987],[30.169037,40.726089],[30.172824,40.725419],[30.179269,40.723807],[30.186463,40.723255],[30.192861,40.726104],[30.200575,40.730654],[30.208246,40.732979],[30.215054,40.732571],[30.224093,40.730908],[30.234907,40.727954],[30.242813,40.725753],[30.245968,40.725968],[30.246514,40.726514],[30.250949,40.741029],[30.249756,40.746952],[30.246628,40.751759],[30.244427,40.757462],[30.243584,40.763456],[30.242929,40.769359],[30.241492,40.774925],[30.23817,40.778396],[30.232971,40.779563],[30.228726,40.779912],[30.227384,40.780039],[30.229788,40.799742],[30.227305,40.805404],[30.222505,40.809513],[30.218464,40.815628],[30.220351,40.822599],[30.22748,40.827635],[30.234592,40.833724],[30.24013,40.840097],[30.244898,40.842249],[30.247823,40.841678],[30.248568,40.841365],[30.26011,40.852004],[30.261925,40.856117],[30.262953,40.860951],[30.263078,40.868548],[30.261612,40.876],[30.259118,40.881272],[30.256061,40.887137],[30.251812,40.892195],[30.246043,40.892696],[30.241242,40.890903],[30.238257,40.891314],[30.234734,40.895485],[30.232093,40.901244],[30.232529,40.90555],[30.233853,40.907609],[30.23426,40.908129],[30.251897,40.906953],[30.258514,40.906688],[30.265218,40.904961],[30.269328,40.902472],[30.271888,40.899271],[30.276894,40.896174],[30.283981,40.896019],[30.288335,40.899904],[30.2873,40.905653],[30.282837,40.91116],[30.279334,40.916816],[30.280099,40.923104],[30.283696,40.928409],[30.285344,40.932218],[30.28297,40.935977],[30.280593,40.940933],[30.282061,40.947013],[30.284794,40.951597],[30.285755,40.952998],[30.274198,40.969446],[30.271429,40.973821],[30.268733,40.975809],[30.265627,40.977844],[30.260616,40.981038],[30.25467,40.982865],[30.249346,40.980888],[30.243945,40.978831],[30.239346,40.982577],[30.239276,40.991209],[30.240965,40.998897],[30.237942,41.003088],[30.232032,41.005945],[30.228408,41.009737],[30.227729,41.013742],[30.229111,41.016433],[30.232705,41.018292],[30.23688,41.020345],[30.239797,41.02322],[30.24279,41.027446],[30.245396,41.032701],[30.245271,41.038826],[30.24536,41.045513],[30.248994,41.050834],[30.252805,41.055476],[30.252849,41.061816],[30.249399,41.068348],[30.245846,41.074623],[30.246205,41.081285],[30.250475,41.085333],[30.255659,41.086281],[30.260506,41.086852],[30.265051,41.087793],[30.269821,41.088825],[30.275653,41.089437],[30.281784,41.090352],[30.286676,41.092972],[30.289367,41.096589],[30.29027,41.10075],[30.291327,41.105211],[30.294482,41.108399],[30.300644,41.11014],[30.307612,41.111639],[30.311792,41.112852],[30.314479,41.114696],[30.319476,41.119895],[30.325339,41.126954],[30.32776,41.13343],[30.32736,41.141473],[30.329424,41.149963],[30.334781,41.154902],[30.338551,41.157766],[30.339226,41.16159],[30.339689,41.165588],[30.343398,41.168257],[30.354169,41.179118],[30.355992,41.18236]]]],"type":"MultiPolygon"}}]};

        // GeoJSON katmanƒ±nƒ± ekle
        const boundaryLayer = L.geoJSON(sakaryaGeoJSON, {
            style: {
                color: '#d63031',        // Daha koyu kƒ±rmƒ±zƒ± renk
                weight: 4,               // √áizgi kalƒ±nlƒ±ƒüƒ±
                opacity: 1,              // Tam opaklƒ±k
                fillColor: '#ffffff',    // Beyaz i√ß dolgu
                fillOpacity: 0.3,        // ƒ∞√ß dolgu opaklƒ±ƒüƒ±
                dashArray: '8, 4'        // Kesikli √ßizgi
            }
        }).addTo(map);

        // Popup ve tooltip ekle
        boundaryLayer.bindPopup('<div style="text-align: center; font-weight: bold; color: #d63031;">üó∫Ô∏è Sakarya ƒ∞li Sƒ±nƒ±rƒ±</div>');
        boundaryLayer.bindTooltip('Sakarya ƒ∞li Sƒ±nƒ±rƒ±', {
            permanent: false,
            direction: 'center',
            className: 'boundary-tooltip'
        });


        // Marker cluster grubu - Sakarya odaklƒ± ayarlar
        let markers = L.markerClusterGroup({
            maxClusterRadius: 30,          // K√ºmeleme yarƒ±√ßapƒ± k√º√ß√ºlt√ºld√º (il√ße seviyesi)
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: 13,   // Bu zoom seviyesinde k√ºmeleme durdur
            maxZoom: 13,                   // Cluster tƒ±klamada max zoom
            spiderfyDistanceMultiplier: 1.2
        });

        let allMarkers = [];

        // Bildirim g√∂ster
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'error' : '';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Excel/CSV dosyasƒ±nƒ± y√ºkle
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // Veriyi d√∂n√º≈üt√ºr
                    dataSet = jsonData.map(row => {
                        return {
                            tarih: row.Tarih || row.tarih || '',
                            yer: row.Yer || row.yer || '',
                            isim: row.ƒ∞sim || row.isim || row.Isim || '',
                            neden: row.Neden || row.neden || '',
                            sektor: row.Sekt√∂r || row.sektor || row.Sektor || 'Diƒüer',
                            lat: parseFloat(row.Enlem || row.enlem || row.Lat || row.lat || 0),
                            lon: parseFloat(row.Boylam || row.boylam || row.Lon || row.lon || 0),
                            link: row.Link || row.link || ''
                        };
                    }).filter(item => item.lat !== 0 && item.lon !== 0); // Koordinatsƒ±z kayƒ±tlarƒ± √ßƒ±kar

                    if (dataSet.length > 0) {
                        populateCityFilter();
                        createMarkers(dataSet);
                        showNotification(`‚úÖ ${dataSet.length} kayƒ±t ba≈üarƒ±yla y√ºklendi!`);
                    } else {
                        showNotification('‚ùå Ge√ßerli veri bulunamadƒ±!', true);
                    }
                } catch (error) {
                    console.error('Dosya okuma hatasƒ±:', error);
                    showNotification('‚ùå Dosya okunamadƒ±! L√ºtfen formatƒ± kontrol edin.', true);
                }
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // √ñrnek ≈üablon indir
        function downloadTemplate() {
            const templateData = [
                {
                    'Tarih': '2024-01-15',
                    'Yer': 'ƒ∞stanbul, Esenyurt',
                    'ƒ∞sim': 'Mehmet Yƒ±lmaz',
                    'Neden': 'ƒ∞n≈üaat iskelesinden d√º≈üme',
                    'Sekt√∂r': 'ƒ∞n≈üaat',
                    'Enlem': 41.0082,
                    'Boylam': 28.9784,
                    'Link': 'https://www.example.com/haber1'
                },
                {
                    'Tarih': '2024-02-03',
                    'Yer': 'Ankara, √áankaya',
                    'ƒ∞sim': 'Ahmet Demir',
                    'Neden': 'Elektrik √ßarpmasƒ±',
                    'Sekt√∂r': 'Enerji',
                    'Enlem': 39.9334,
                    'Boylam': 32.8597,
                    'Link': 'https://www.example.com/haber2'
                },
                {
                    'Tarih': '2024-02-20',
                    'Yer': 'ƒ∞zmir, Bornova',
                    'ƒ∞sim': 'Ali Kaya',
                    'Neden': 'Makine kazasƒ±',
                    'Sekt√∂r': 'Metal',
                    'Enlem': 38.4237,
                    'Boylam': 27.1428,
                    'Link': 'https://www.example.com/haber3'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ƒ∞≈ü Kazalarƒ±");
            
            // S√ºtun geni≈üliklerini ayarla
            ws['!cols'] = [
                { wch: 12 },  // Tarih
                { wch: 25 },  // Yer
                { wch: 20 },  // ƒ∞sim
                { wch: 30 },  // Neden
                { wch: 15 },  // Sekt√∂r
                { wch: 12 },  // Enlem
                { wch: 12 },  // Boylam
                { wch: 40 }   // Link
            ];

            XLSX.writeFile(wb, 'is_kazalari_sablon.xlsx');
            showNotification('‚úÖ ≈ûablon dosyasƒ± indirildi!');
        }

        // ƒ∞l√ße listesini doldur
        function populateCityFilter() {
            const districts = [...new Set(dataSet.map(item => {
                const parts = item.yer.split(',');
                return parts.length > 1 ? parts[1].trim() : parts[0].trim();
            }))].sort();
            const select = document.getElementById('cityFilter');
            select.innerHTML = '<option value="">T√ºm ƒ∞l√ßeler</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                select.appendChild(option);
            });
        }

        // Markerlarƒ± olu≈ütur
        function createMarkers(data) {
            markers.clearLayers();
            allMarkers = [];

            data.forEach(item => {
                const icon = L.divIcon({
                    className: 'custom-marker',
                    iconSize: [20, 20],
                    html: '<div style="width: 100%; height: 100%; border-radius: 50%;"></div>'
                });

                const marker = L.marker([item.lat, item.lon], { icon: icon });
                
                const popupContent = `
                    <div class="popup-title">${item.isim}</div>
                    <div class="popup-info">
                        <span class="popup-label">üìÖ Tarih:</span> ${formatDate(item.tarih)}
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">üìç Yer:</span> ${item.yer}
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">üè≠ Sekt√∂r:</span> ${item.sektor || 'Belirtilmemi≈ü'}
                    </div>
                    <div class="popup-info">
                        <span class="popup-label">‚ö†Ô∏è Neden:</span> ${item.neden}
                    </div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="popup-link">üîó Haberi Oku</a>` : ''}
                `;
                
                marker.bindPopup(popupContent);
                marker.data = item;
                allMarkers.push(marker);
                markers.addLayer(marker);
            });

            map.addLayer(markers);
            
            // Haritayƒ± t√ºm markerlarƒ± g√∂sterecek ≈üekilde otomatik ayarla
            if (data.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1), {
                    maxZoom: 10,  // √áok fazla zoom yapmasƒ±n
                    animate: true,
                    duration: 1.0
                });
            }
            
            updateStats(data.length);
        }

        // Tarih formatlama
        function formatDate(dateString) {
            if (!dateString) return 'Bilinmiyor';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // ƒ∞statistikleri g√ºncelle
        function updateStats(displayed) {
            document.getElementById('totalRecords').textContent = dataSet.length;
            document.getElementById('displayedRecords').textContent = displayed;
            
            // Infografiƒüi g√∂ster
            if (displayed > 0) {
                generateInfographic(dataSet.filter((item, index) => {
                    const searchText = document.getElementById('searchBox').value.toLowerCase();
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    const district = document.getElementById('cityFilter').value;

                    const matchSearch = !searchText || 
                        item.isim.toLowerCase().includes(searchText) ||
                        item.yer.toLowerCase().includes(searchText) ||
                        item.neden.toLowerCase().includes(searchText);

                    const matchStartDate = !startDate || item.tarih >= startDate;
                    const matchEndDate = !endDate || item.tarih <= endDate;
                    
                    const itemDistrict = item.yer.split(',').length > 1 ? 
                        item.yer.split(',')[1].trim() : item.yer.split(',')[0].trim();
                    const matchDistrict = !district || itemDistrict === district;

                    return matchSearch && matchStartDate && matchEndDate && matchDistrict;
                }));
            } else {
                document.getElementById('infographic').classList.remove('show');
            }
        }

        // ƒ∞nfografik olu≈ütur
        function generateInfographic(data) {
            if (data.length === 0) {
                return;
            }

            // ƒ∞nfografiƒüi olu≈ütur ama otomatik g√∂sterme

            // ƒ∞l√ße analizi
            const districtData = {};
            data.forEach(item => {
                const parts = item.yer.split(',');
                const district = parts.length > 1 ? parts[1].trim() : parts[0].trim();
                districtData[district] = (districtData[district] || 0) + 1;
            });

            const topDistricts = Object.entries(districtData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Sekt√∂r analizi
            const sectorData = {};
            data.forEach(item => {
                const sector = item.sektor || 'Diƒüer';
                sectorData[sector] = (sectorData[sector] || 0) + 1;
            });

            const topSectors = Object.entries(sectorData)
                .sort((a, b) => b[1] - a[1]);

            // Neden analizi
            const reasonData = {};
            data.forEach(item => {
                const reason = item.neden.substring(0, 30);
                reasonData[reason] = (reasonData[reason] || 0) + 1;
            });

            const topReasons = Object.entries(reasonData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Ay analizi
            const monthData = {};
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                              'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            data.forEach(item => {
                if (item.tarih) {
                    const month = new Date(item.tarih).getMonth();
                    const monthName = monthNames[month];
                    monthData[monthName] = (monthData[monthName] || 0) + 1;
                }
            });

            const topMonth = Object.entries(monthData)
                .sort((a, b) => b[1] - a[1])[0];

            // Kartlarƒ± g√ºncelle
            document.getElementById('topCity').textContent = 
                topDistricts[0] ? `${topDistricts[0][0]} (${topDistricts[0][1]})` : '-';
            document.getElementById('topReason').textContent = 
                topReasons[0] ? `${topReasons[0][0]}... (${topReasons[0][1]})` : '-';
            document.getElementById('topSector').textContent = 
                topSectors[0] ? `${topSectors[0][0]} (${topSectors[0][1]})` : '-';
            document.getElementById('topMonth').textContent = 
                topMonth ? `${topMonth[0]} (${topMonth[1]})` : '-';
            document.getElementById('cityCount').textContent = 
                `${Object.keys(districtData).length} ƒ∞l√ße`;

            // ƒ∞l√ße grafiƒüi
            const maxDistrictValue = topDistricts[0] ? topDistricts[0][1] : 1;
            let districtChartHTML = '';
            topDistricts.forEach(([district, count]) => {
                const percentage = (count / maxDistrictValue) * 100;
                districtChartHTML += `
                    <div class="chart-item">
                        <div class="chart-label">${district}</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${count}</div>
                    </div>
                `;
            });
            document.getElementById('cityChart').innerHTML = districtChartHTML;

            // Sekt√∂r grafiƒüi
            const maxSectorValue = topSectors[0] ? topSectors[0][1] : 1;
            let sectorChartHTML = '';
            topSectors.forEach(([sector, count]) => {
                const percentage = (count / maxSectorValue) * 100;
                sectorChartHTML += `
                    <div class="chart-item">
                        <div class="chart-label">${sector}</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${count}</div>
                    </div>
                `;
            });
            document.getElementById('sectorChart').innerHTML = sectorChartHTML;

            // Neden grafiƒüi
            const maxReasonValue = topReasons[0] ? topReasons[0][1] : 1;
            let reasonChartHTML = '';
            topReasons.forEach(([reason, count]) => {
                const percentage = (count / maxReasonValue) * 100;
                reasonChartHTML += `
                    <div class="chart-item">
                        <div class="chart-label">${reason}...</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${count}</div>
                    </div>
                `;
            });
            document.getElementById('reasonChart').innerHTML = reasonChartHTML;
        }

        // Filtreleri uygula
        function applyFilters() {
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const district = document.getElementById('cityFilter').value;

            const filtered = dataSet.filter(item => {
                // Arama filtresi
                const matchSearch = !searchText || 
                    item.isim.toLowerCase().includes(searchText) ||
                    item.yer.toLowerCase().includes(searchText) ||
                    item.neden.toLowerCase().includes(searchText);

                // Tarih filtresi
                const matchStartDate = !startDate || item.tarih >= startDate;
                const matchEndDate = !endDate || item.tarih <= endDate;

                // ƒ∞l√ße filtresi
                const itemDistrict = item.yer.split(',').length > 1 ? 
                    item.yer.split(',')[1].trim() : item.yer.split(',')[0].trim();
                const matchDistrict = !district || itemDistrict === district;

                return matchSearch && matchStartDate && matchEndDate && matchDistrict;
            });

            createMarkers(filtered);
        }

        // Filtreleri sƒ±fƒ±rla
        function resetFilters() {
            document.getElementById('searchBox').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('cityFilter').value = '';
            createMarkers(dataSet);
        }

        // ƒ∞nfografik g√∂ster/gizle
        // Sayfa y√ºklendiƒüinde
        updateStats(0);

        // Arama kutusunda her tu≈üta filtrele
        document.getElementById('searchBox').addEventListener('input', applyFilters);
    </script>
</body>
</html>
